create a python web app using uvicon and sse. The app automatically determines the user preference for dark or light mode and implements both themes. Let's call the app "Stash Shrink" and add a header to the top with the name. A settings button on the right of the title opens a modal to enter general app settings of the stash end point url and optional api key and default search result amount of 50. A second section should have fields to set desired video output options for width, height, bitrate, framerate,buffer size and container and max concurrent tasks set to 2. the end point defaults to http://localhost:9999 this should be stored in a config file. When no config file exists, the app should show the settings modal when opened for the first time to get the user to enter the details.
The front page of the app provides a search form with fields for max video width, height, bitrate, framerate, codec as well as path and a submit button.
Based on the entered search parameters, the app should connect to the configured stash end point with api key if configured and perform a stash scene search for all videos that exceed the given max width, height, bitrate, framerate or are not in the given codec. If a path is given, limit the search results to files in the provided path.
the search results should show the scene title and all the properties including duration, filesize and path. The title is a link to open the particular scene in stash itself in a new window.
the search results should be sortable by clicking on the header and toggle between ascending, descending and as is for all columns.
the search results should have checkboxes on the left to be able to select scenes. Quick toggles to select all, none and invert should be provided.
the search results should include pagination with 50 items by default, but a dropdown to select 50,100,250,500,1000,all.
a "convert videos" button will submit all selected videos to the main function of this tool.
This will process the selected videos using ffmpeg with maximum of the configured concurrent tasks. A 'conversion' page will be shown that shows the list of all the selected videos similar to the search results. This will be the pending queue. It starts converting the videos in order using ffmpeg and show a progress bar, estimated time left and percentage of the videos currently being processed. A cancel all button will allow to stop all processing. next to each video vile in queue is an option to remove it.
the default ffmpeg command used (might be changed later or receive added options) should be:
ffmpeg -i "'"$inputfilename"'" -filter_complex "scale=ceil(iw*min(1\,min('$maxwidth'/iw\,'$maxheight'/ih))/2)*2:-2" -c:v libx264 '$framerate' -crf 28 -c:a aac '$subtitle_option' -b:v '$bitrate' -maxrate '$bitrate' -buffersize '$buffersize' -f '$container' "'"$outputfilename"'"'
the output filename shall be the same as the input but with added 'converting' in the filename to indicate that it's a temporary file. when the file was converted without any errors, the file should be renamed with the appropriate container extension. if it is the same extension as the original file, a number should be added before the extension. check if such a file exists and increase the number until one is found that does not exist. the stash scene this file belongs to should be updated and the references to the original file should be replaced with the new one. stash should be triggered to re-scan this file to update its properties in the library. when this all worked fine, the original file should be deleted. On the web interface this scene should be shown as completed with an option to remove the entry from the web list (also add a 'clear all completed' option).
once that's done, the task can continue with the next file in the queue.
for each conversion task, keep a log in a logs subfolder with filename of the stash id. In case of fatal errors, mark the item in the web interface as having errors and provide option to see the log file content in a modal. add a retry option. this will append to the log file.

